<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>undefined scene â€” Watcher Rank</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0b0b0c;
      --surface: #111113;
      --border: #2a2a2e;
      --gold: #c9a84c;
      --gold-dim: #7a5f28;
      --silver: #8a9aaa;
      --bronze: #8b5e3c;
      --text: #e8e4dc;
      --muted: #5a5a60;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Noto Serif KR', serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(ellipse 80% 50% at 50% -10%, rgba(201,168,76,0.07) 0%, transparent 60%),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 680px;
      margin: 0 auto;
      padding: 48px 24px 80px;
    }

    header {
      text-align: center;
      margin-bottom: 48px;
    }

    .brand {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      letter-spacing: 0.3em;
      color: var(--gold);
      text-transform: uppercase;
      margin-bottom: 16px;
      opacity: 0;
      animation: fadeUp 0.6s 0.1s forwards;
    }

    .event-title {
      font-size: clamp(26px, 7vw, 40px);
      font-weight: 900;
      line-height: 1.15;
      letter-spacing: -0.02em;
      margin-bottom: 20px;
      opacity: 0;
      animation: fadeUp 0.6s 0.2s forwards;
    }

    .divider {
      width: 48px;
      height: 1px;
      background: var(--gold-dim);
      margin: 0 auto 20px;
      opacity: 0;
      animation: fadeUp 0.6s 0.3s forwards;
    }

    .meta {
      font-family: 'DM Mono', monospace;
      font-size: 12px;
      color: var(--muted);
      letter-spacing: 0.1em;
      opacity: 0;
      animation: fadeUp 0.6s 0.35s forwards;
    }

    .meta span { color: var(--text); font-weight: 500; }

    .board {
      border: 1px solid var(--border);
      border-radius: 2px;
      overflow: hidden;
      background: var(--surface);
    }

    .col-header {
      display: grid;
      grid-template-columns: 52px 1fr 140px 110px;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      background: rgba(201,168,76,0.04);
    }

    .col-header span {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      letter-spacing: 0.2em;
      color: var(--muted);
      text-transform: uppercase;
    }

    .col-header .col-score,
    .col-header .col-date { text-align: right; }

    .row {
      display: grid;
      grid-template-columns: 52px 1fr 140px 110px;
      align-items: center;
      padding: 18px 20px;
      border-bottom: 1px solid rgba(42,42,46,0.5);
      position: relative;
      opacity: 0;
      transform: translateY(10px);
      transition: background 0.2s;
    }

    .row:last-child { border-bottom: none; }
    .row:hover { background: rgba(201,168,76,0.03); }

    .row.rank-1::before { content:''; position:absolute; left:0; top:0; bottom:0; width:3px; background:var(--gold); }
    .row.rank-2::before { content:''; position:absolute; left:0; top:0; bottom:0; width:3px; background:var(--silver); }
    .row.rank-3::before { content:''; position:absolute; left:0; top:0; bottom:0; width:3px; background:var(--bronze); }

    .row.visible {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.4s, transform 0.4s;
    }

    .rank-num { font-family:'DM Mono',monospace; font-size:13px; font-weight:500; }
    .rank-1 .rank-num { color: var(--gold); }
    .rank-2 .rank-num { color: var(--silver); }
    .rank-3 .rank-num { color: var(--bronze); }
    .row:not(.rank-1):not(.rank-2):not(.rank-3) .rank-num { color: var(--muted); }

    .medal { display:inline-block; font-size:14px; margin-right:6px; }

    .team-name { font-size:15px; font-weight:700; letter-spacing:-0.01em; padding-right:12px; }

    .score { font-family:'DM Mono',monospace; font-size:15px; font-weight:500; text-align:right; padding-right:12px; letter-spacing:-0.02em; }
    .rank-1 .score { color: var(--gold); }
    .rank-2 .score { color: var(--silver); }
    .rank-3 .score { color: var(--bronze); }

    .date { font-family:'DM Mono',monospace; font-size:10px; color:var(--muted); text-align:right; line-height:1.6; }

    .status-bar {
      margin-top: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 2px;
      opacity: 0;
      animation: fadeUp 0.6s 0.8s forwards;
    }

    #statusMsg { font-family:'DM Mono',monospace; font-size:10px; color:var(--muted); letter-spacing:0.08em; }
    #countdownWrap { font-family:'DM Mono',monospace; font-size:10px; color:#3a3a40; letter-spacing:0.1em; }

    footer {
      margin-top: 40px;
      text-align: center;
      opacity: 0;
      animation: fadeUp 0.6s 1.0s forwards;
    }

    .footer-logo { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:0.35em; color:var(--muted); text-transform:uppercase; }
    .footer-logo strong { color: var(--gold-dim); }

    @keyframes fadeUp {
      from { opacity:0; transform:translateY(12px); }
      to   { opacity:1; transform:translateY(0); }
    }

    @media (max-width: 480px) {
      .col-header { grid-template-columns: 44px 1fr 110px 85px; }
      .row        { grid-template-columns: 44px 1fr 110px 85px; padding: 16px 14px; }
      .team-name  { font-size: 14px; }
      .score      { font-size: 16px; }
      .date       { font-size: 9px; }
    }
  </style>
</head>
<body>

<div class="container">

  <header>
    <div class="brand">undefined scene</div>
    <h1 class="event-title">Watcher Rank</h1>
    <div class="divider"></div>
    <p class="meta">ì´ ì°¸ì—¬íŒ€ <span id="totalTeams">â€”</span>íŒ€ &nbsp;Â·&nbsp; <span id="eventDate">â€”</span></p>
  </header>

  <div class="board">
    <div class="col-header">
      <span>ìˆœìœ„</span>
      <span>íŒ€ëª…</span>
      <span class="col-score">ì ìˆ˜</span>
      <span class="col-date">ì°¸ì—¬ ì¼ì‹œ</span>
    </div>
    <div id="boardBody"></div>
  </div>

  <div class="status-bar">
    <span id="statusMsg"></span>
    <span id="countdownWrap">ê°±ì‹  <span id="countdownEl">30s</span></span>
  </div>

  <footer>
    <p class="footer-logo"><strong>undefined scene</strong> &nbsp;Â·&nbsp; Mystery Experience</p>
  </footer>

</div>

<script>
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // âœï¸  ìš´ì˜ì ì„¤ì • â€” ì—¬ê¸°ë§Œ ìˆ˜ì •í•˜ì„¸ìš”
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const today = new Date();
  const EVENT_DATE = today.getFullYear() + "." + String(today.getMonth()+1).padStart(2,"0") + "." + String(today.getDate()).padStart(2,"0");

  // êµ¬ê¸€ ì‹œíŠ¸ ê³µê°œ CSV ë§í¬
  // ì‹œíŠ¸ â†’ íŒŒì¼ â†’ ê³µìœ  â†’ ì›¹ì— ê²Œì‹œ â†’ CSV â†’ ë§í¬ ë³µì‚¬ â†’ ì•„ë˜ ë¶™ì—¬ë„£ê¸°
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSOu9HBuOr3Q-yPmVVC4VpCfSP1_iygZE1v6JrfG7w9xiqPOXrWDQCqzsAr0MYyfK_LWAWepbtHWSGz/pub?output=csv";

  // ìë™ ê°±ì‹  ì£¼ê¸° (ì´ˆ)
  const REFRESH_INTERVAL = 30;

  // êµ¬ê¸€ í¼ ì‘ë‹µ ì‹œíŠ¸ì˜ ì»¬ëŸ¼ ìˆœì„œ (0ë¶€í„° ì‹œì‘)
  // ê¸°ë³¸: íƒ€ì„ìŠ¤íƒ¬í”„(0) | íŒ€ëª…(1) | ì ìˆ˜(2) | ì°¸ì—¬ì¼ì‹œ(3)
  const COL = { timestamp: 0, team_name: 1, score: 2, time_col: 3, date_col: 4 };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  let countdown = REFRESH_INTERVAL;
  let timer;

  const MEDALS = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];

  const SAMPLE_DATA = [
    { team_name: "ë¶‰ì€ ì—¬ì™•ë‹¨",    score: 97, submitted_at: "2025-06-14T20:14:32" },
    { team_name: "ê·¸ë¦¼ì íƒì •ì†Œ",  score: 97, submitted_at: "2025-06-14T20:22:10" },
    { team_name: "ìƒˆë²½ì˜ ëª©ê²©ì",  score: 88, submitted_at: "2025-06-14T20:31:45" },
    { team_name: "ë¯¸ì™„ì„± ìœ ì–¸ì¥",  score: 82, submitted_at: "2025-06-14T20:40:01" },
    { team_name: "13ë²ˆ ë°©ì˜ ì†ë‹˜", score: 75, submitted_at: "2025-06-14T20:55:18" },
    { team_name: "ì£„ì™€ ë²Œ í´ëŸ½",   score: 70, submitted_at: "2025-06-14T21:02:33" },
  ];

  function formatDate(str) {
    if (!str || !str.trim()) return 'â€”â€”\nâ€”â€”';

    // êµ¬ê¸€ í¼ í•œêµ­ì–´ íƒ€ì„ìŠ¤íƒ¬í”„: "2025. 6. 14 ì˜¤í›„ 9:00:00"
    const korMatch = str.match(/(\d{4})[\.\s]+(\d{1,2})[\.\s]+(\d{1,2})[\.\s]*(ì˜¤ì „|ì˜¤í›„)?\s*(\d{1,2}):(\d{2})/);
    if (korMatch) {
      const yy = korMatch[1];
      const mm = korMatch[2].padStart(2, '0');
      const dd = korMatch[3].padStart(2, '0');
      let hh = parseInt(korMatch[5]);
      const mi = korMatch[6];
      const ampm = korMatch[4];
      if (ampm === 'ì˜¤í›„' && hh < 12) hh += 12;
      if (ampm === 'ì˜¤ì „' && hh === 12) hh = 0;
      return yy + '.' + mm + '.' + dd + '\n' + String(hh).padStart(2,'0') + ':' + mi;
    }

    // ISO ë˜ëŠ” ê¸°íƒ€ íŒŒì‹± ê°€ëŠ¥í•œ í˜•ì‹
    const d = new Date(str);
    if (!isNaN(d.getTime())) {
      const yy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      const hh = String(d.getHours()).padStart(2, '0');
      const mi = String(d.getMinutes()).padStart(2, '0');
      return yy + '.' + mm + '.' + dd + '\n' + hh + ':' + mi;
    }

    return str.slice(0, 8) + '\nâ€”â€”';
  }

  function formatDatetime(dateStr, timeStr) {
    // ë‚ ì§œ íŒŒì‹±: "6/14/2025" or "2025-06-14" or "2025. 6. 14" ë“±
    let yy = 'â€”â€”', mm = 'â€”â€”', dd = 'â€”â€”';
    if (dateStr && dateStr.trim()) {
      const d = new Date(dateStr);
      if (!isNaN(d.getTime())) {
        yy = d.getFullYear();
        mm = String(d.getMonth() + 1).padStart(2, '0');
        dd = String(d.getDate()).padStart(2, '0');
      } else {
        const m = dateStr.match(/(\d{4})[.\-\/\s]+(\d{1,2})[.\-\/\s]+(\d{1,2})/);
        const m2 = dateStr.match(/(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{4})/);
        if (m) { yy=m[1]; mm=m[2].padStart(2,'0'); dd=m[3].padStart(2,'0'); }
        else if (m2) { yy=m2[3]; mm=m2[1].padStart(2,'0'); dd=m2[2].padStart(2,'0'); }
      }
    }
    // ì‹œê°„ íŒŒì‹±: "21:00" or "ì˜¤í›„ 9:00" ë“±
    let time = 'â€”â€”';
    if (timeStr && timeStr.trim()) {
      const korMatch = timeStr.match(/(ì˜¤ì „|ì˜¤í›„)?\s*(\d{1,2}):(\d{2})/);
      if (korMatch) {
        let hh = parseInt(korMatch[2]);
        const mi = korMatch[3];
        if (korMatch[1] === 'ì˜¤í›„' && hh < 12) hh += 12;
        if (korMatch[1] === 'ì˜¤ì „' && hh === 12) hh = 0;
        time = String(hh).padStart(2,'0') + ':' + mi;
      } else {
        time = timeStr.slice(0,5);
      }
    }
    return [yy + '.' + mm + '.' + dd, time];
  }

  function formatScore(n) {
    return n.toLocaleString('ko-KR') + 'ì›';
  }

  function parseCSV(text) {
    const lines = text.trim().split('\n').slice(1); // í—¤ë” ì œê±°
    return lines
      .map(line => {
        const cols = [];
        let cur = '', inQ = false;
        for (const c of line) {
          if (c === '"') { inQ = !inQ; }
          else if (c === ',' && !inQ) { cols.push(cur.trim()); cur = ''; }
          else { cur += c; }
        }
        cols.push(cur.trim());
        return cols;
      })
      .filter(cols => cols[COL.team_name] && cols[COL.score] && cols[COL.score].trim() !== '')
      .map(cols => ({
        team_name:    cols[COL.team_name] || '',
        score:        parseFloat(cols[COL.score]) || 0,
        date_str:     cols[COL.date_col]  || '',
        time_str:     cols[COL.time_col]  || '',
      }));
  }

  function renderBoard(data) {
    const sorted = [...data].sort((a, b) => {
      if (b.score !== a.score) return b.score - a.score;
      return new Date(a.date_str) - new Date(b.date_str);
    });

    document.getElementById('totalTeams').textContent = sorted.length;
    document.getElementById('eventDate').textContent = EVENT_DATE;

    const body = document.getElementById('boardBody');
    body.innerHTML = '';

    sorted.forEach((team, i) => {
      const rank = i + 1;
      const row = document.createElement('div');
      row.className = 'row rank-' + rank;
      const dateLines = formatDatetime(team.date_str, team.time_str);
      const rankDisplay = MEDALS[i] !== undefined
        ? '<span class="medal">' + MEDALS[i] + '</span>'
        : rank;
      row.innerHTML =
        '<div class="rank-num">' + rankDisplay + '</div>' +
        '<div class="team-name">' + team.team_name + '</div>' +
        '<div class="score">' + formatScore(team.score) + '</div>' +
        '<div class="date">' + (dateLines[0] || 'â€”â€”') + '<br>' + (dateLines[1] || 'â€”â€”') + '</div>';
      body.appendChild(row);
      setTimeout(function(r) { return function() { r.classList.add('visible'); }; }(row), 60 * i);
    });
  }

  function setStatus(msg, isError) {
    const el = document.getElementById('statusMsg');
    el.textContent = msg;
    el.style.color = isError ? '#c0392b' : '#5a5a60';
  }

  async function fetchData() {
    if (SHEET_CSV_URL.startsWith('ì—¬ê¸°ì—')) {
      renderBoard(SAMPLE_DATA);
      setStatus('âš  ìƒ˜í”Œ ë°ì´í„° â€” SHEET_CSV_URLì„ ì—°ê²°í•´ì£¼ì„¸ìš”', true);
      return;
    }
    setStatus('ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦', false);
    try {
      // CORS ìš°íšŒ: ì—¬ëŸ¬ í”„ë¡ì‹œ ìˆœì°¨ ì‹œë„
      let text = null;
      const proxies = [
        () => fetch('https://corsproxy.io/?' + encodeURIComponent(SHEET_CSV_URL)).then(r => { if(!r.ok) throw new Error(r.status); return r.text(); }),
        () => fetch('https://api.allorigins.win/get?url=' + encodeURIComponent(SHEET_CSV_URL)).then(r => r.json()).then(j => j.contents),
        () => fetch('https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(SHEET_CSV_URL)).then(r => { if(!r.ok) throw new Error(r.status); return r.text(); }),
      ];
      for (const proxy of proxies) {
        try { text = await proxy(); if (text && text.length > 10) break; } catch(e) { text = null; }
      }
      if (!text) throw new Error('ëª¨ë“  í”„ë¡ì‹œ ì‹¤íŒ¨');
      const data = parseCSV(text);
      if (data.length === 0) throw new Error('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
      renderBoard(data);
      setStatus('ì—…ë°ì´íŠ¸: ' + new Date().toLocaleTimeString('ko-KR'), false);
    } catch (e) {
      setStatus('âŒ ' + e.message, true);
    }
  }

  function startCountdown() {
    clearInterval(timer);
    countdown = REFRESH_INTERVAL;
    document.getElementById('countdownEl').textContent = countdown + 's';
    timer = setInterval(function() {
      countdown--;
      document.getElementById('countdownEl').textContent = countdown + 's';
      if (countdown <= 0) {
        fetchData();
        countdown = REFRESH_INTERVAL;
      }
    }, 1000);
  }

  fetchData();
  startCountdown();
</script>
</body>
</html>
